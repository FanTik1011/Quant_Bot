<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ó–≤—ñ—Ç –∫—Ä–∞—Ñ—Ç—É | BCSD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{
      --bg1: rgba(88,101,242,.18);
      --bg2: rgba(14,165,233,.16);
      --glass: rgba(15,18,30,.78);
      --glass-strong: rgba(15,18,30,.88);
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.14);
      --soft: rgba(255,255,255,.85);
      --head-grad: linear-gradient(90deg,#0ea5e9 0%, #14b8a6 50%, #22c55e 100%);
      --focus: rgba(14,165,233,.25);
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
    }
    body{
      background:
        radial-gradient(1100px 520px at 110% -10%, var(--bg1), transparent 55%),
        radial-gradient(1000px 780px at -15% 120%, var(--bg2), transparent 60%),
        url("/static/bg.jpg") center/cover fixed no-repeat;
      min-height:100vh; color:#fff; font-family:'Segoe UI', system-ui, -apple-system, sans-serif;
      display:flex; align-items:flex-start; justify-content:center; padding:28px;
    }
    .shell{ width:100%; max-width:1100px; }

    /* –®–∞–ø–∫–∞ */
    .hero{
      background: var(--head-grad);
      border-radius: 22px;
      padding: 16px 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.4);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .hero .ttl{ font-weight:900; letter-spacing:.2px; margin:0; text-shadow:0 10px 26px rgba(0,0,0,.35) }
    .hero small{ opacity:.95 }
    .logout{
      background:#dc3545; border:none; color:#fff; font-weight:700; padding:.6rem .95rem; border-radius:.9rem;
      transition:.2s;
    }
    .logout:hover{ background:#b02a37; transform: translateY(-1px) }

    /* –ö–∞—Ä—Ç–∏ */
    .grid{
      display:grid; grid-template-columns: 1.05fr .95fr; gap:18px; margin-top:18px;
    }
    @media (max-width: 960px){ .grid{ grid-template-columns:1fr } }
    .card-glass{
      background:var(--glass); border:1px solid var(--border); border-radius:22px; padding:18px;
      backdrop-filter: blur(10px); box-shadow:0 24px 64px rgba(0,0,0,.55); transition:.25s;
    }
    .card-glass:hover{ background:var(--glass-strong) }
    .group-title{ font-weight:800; margin-bottom:10px; display:flex; align-items:center; gap:.5rem }

    /* –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ */
    .items{
      max-height: 62vh; overflow:auto;
      background: var(--panel); border:1px solid var(--border); border-radius:18px; padding:14px;
    }
    .row-item{
      display:grid; grid-template-columns: 1fr 126px; gap:10px; align-items:center;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px; padding:10px 12px; margin-bottom:10px;
    }
    .row-item label{ margin:0; font-weight:700 }

    /* –ü—Ä–∞–≤–∏–π —Å–∞–π–¥ */
    .summary{ background: var(--panel); border:1px solid var(--border); border-radius:18px; padding:16px; }
    .muted{ color:var(--soft) }
    .cap{ font-weight:900 }
    .kv{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px; padding:10px 12px; margin:8px 0;
    }

    .form-control, .form-select{
      background:#ffffff !important; color:#000 !important;
      border:1px solid #d0d7e2 !important; border-radius:.85rem !important;
      padding:.6rem .8rem !important; box-shadow:none !important;
    }
    .form-control:focus, .form-select:focus{
      border-color:#93c5fd !important;
      box-shadow:0 0 0 .25rem var(--focus) !important;
      outline:none;
    }

    /* –ö–Ω–æ–ø–∫–∞ */
    .btn-send{
      background:var(--head-grad); border:none; color:#001018; font-weight:900;
      padding:.9rem 1.1rem; border-radius:1rem; width:100%; letter-spacing:.2px; transition:.2s;
      box-shadow: 0 12px 32px rgba(20,184,166,.25);
    }
    .btn-send:hover{ transform:translateY(-1px); filter:brightness(1.03) }

    /* –ü—Ä–æ–≥—Ä–µ—Å –ø–æ –ª—ñ–º—ñ—Ç—É */
    .progress-wrap{ margin-top:10px }
    .progress{
      height: 12px; border-radius: 999px; background: rgba(255,255,255,.15);
      border:1px solid var(--border);
    }
    .progress-bar{
      background: var(--head-grad);
    }
    .badge-soft{ background: rgba(255,255,255,.14); color:#fff; border:1px solid var(--border) }

    .note{ font-size:.9rem; opacity:.95 }
  </style>
</head>
<body>
  <div class="shell">
    <!-- –®–∞–ø–∫–∞ -->
    <div class="hero">
      <div>
        <h3 class="ttl">üß∞ –ó–≤—ñ—Ç –∫—Ä–∞—Ñ—Ç—É</h3>
        <small>BCSD Department ‚Äî –æ—Ñ—ñ—Ü—ñ–π–Ω–∞ —Ñ–æ—Ä–º–∞ –ø–æ–¥–∞—á—ñ</small>
      </div>
      {% if session.get('user') %}
        <a href="/logout" class="btn logout">üö™ –í–∏–π—Ç–∏</a>
      {% endif %}
    </div>

    {% if request.args.get('ok') %}
      <div class="alert alert-success mt-3 border-0 shadow-sm">‚úÖ –ó–≤—ñ—Ç —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ.</div>
    {% endif %}

    <form method="post" id="craftForm" class="mt-3">
      <div class="grid">
        <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –ø—Ä–µ–¥–º–µ—Ç–∏ -->
        <div class="card-glass">
          <div class="group-title">üì¶ –°–Ω–∞—Ä—è–¥–∂–µ–Ω–Ω—è</div>
          <div class="items">
            {% for key, item in catalog.items() %}
              <div class="row-item">
                <label class="form-label">{{ item.label }}</label>
                <input type="number" min="0" step="1" value="0" class="form-control" name="q_{{ key }}" data-key="{{ key }}">
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è + –ø—ñ–¥—Å—É–º–æ–∫ -->
        <div class="card-glass summary">
          <div class="group-title">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>

          <div class="mb-3">
            <label class="form-label">–•—Ç–æ –∫—Ä–∞—Ñ—Ç–∏—Ç—å</label>
            <input class="form-control" value="{{ session['user']['username'] if session.get('user') else '' }}" disabled>
            <div class="form-text">–ü—ñ–¥—Ç—è–≥—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑ Discord.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">–†—ñ–≤–µ–Ω—å –∑–±—Ä–æ—è—Ä–∞</label>
            <select class="form-select" name="level" id="level">
              {% for lvl, info in levels.items() %}
                <option value="{{ lvl }}">–†—ñ–≤–µ–Ω—å {{ lvl }} (–∑–Ω–∏–∂–∫–∞ –Ω–∞ –∑–±—Ä–æ—é: {{ info.discount_pct }}%)</option>
              {% endfor %}
            </select>
            <div class="form-text">–ó–Ω–∏–∂–∫–∞ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è <b>–ª–∏—à–µ</b> –¥–æ –∑–±—Ä–æ—ó (–Ω–µ –¥–æ –∞–º—É–Ω—ñ—Ü—ñ—ó —Ç–∞ —Å–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è).</div>
          </div>

          <div class="mb-3">
            <label class="form-label">–ú–µ—Ç–∞ (–¥–æ–±–æ–≤–∞ –Ω–æ—Ä–º–∞ / –í–ó–• / –í–ó–ì / –í–ó–ê / –ü–æ—Å—Ç–∞—á–∞–Ω–Ω—è)</label>
            <input class="form-control" name="purpose" placeholder="–¥–æ–±–æ–≤–∞ –Ω–æ—Ä–º–∞ –º–æ—è" required>
          </div>

          <hr class="border-secondary">

          <div class="kv">
            <div class="muted">–õ—ñ–º—ñ—Ç –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ –∑–∞ —Ä–æ–ª–ª—é</div>
            <div class="cap"><span id="cap">{{ role_cap }}</span> –º–∞—Ç.</div>
          </div>
          <div class="kv">
            <div class="muted">–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ —Å—É–º–∞ (–∑ —É—Ä–∞—Ö. –∑–Ω–∏–∂–∫–∏)</div>
            <div class="cap"><span id="sum">0</span> –º–∞—Ç.</div>
          </div>
          <div class="mt-1">
            <span class="badge badge-soft" id="discountBadge">–ó–Ω–∏–∂–∫–∞: 0%</span>
          </div>

          <!-- –ü—Ä–æ–≥—Ä–µ—Å -->
          <div class="progress-wrap">
            <div class="d-flex justify-content-between muted mb-1">
              <small>–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ª—ñ–º—ñ—Ç—É</small>
              <small id="pct">0%</small>
            </div>
            <div class="progress">
              <div class="progress-bar" id="bar" role="progressbar" style="width:0%"></div>
            </div>
          </div>

          <button class="btn btn-send mt-3" type="submit">üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç</button>

          <div class="mt-3 note">
            üìå –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è: –∑–Ω–∏–∂–∫–∞ –¥—ñ—î —Ç—ñ–ª—å–∫–∏ –Ω–∞ –∑–±—Ä–æ—é. –Ø–∫—â–æ —Å—É–º–∞ –ø–µ—Ä–µ–≤–∏—â–∏—Ç—å –ª—ñ–º—ñ—Ç ‚Äî –∑–Ω–∞—á–µ–Ω–Ω—è –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç—å—Å—è —á–µ—Ä–≤–æ–Ω–∏–º.
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
    // –î–∞–Ω—ñ –∫–∞—Ç–∞–ª–æ–≥—É –¥–ª—è –∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ–≥–æ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É
    const CATALOG = {{ catalog | tojson }};
    const LEVELS  = {{ levels | tojson }};
    const capEl   = document.getElementById('cap');
    const sumEl   = document.getElementById('sum');
    const levelEl = document.getElementById('level');
    const discountBadge = document.getElementById('discountBadge');
    const pctEl  = document.getElementById('pct');
    const barEl  = document.getElementById('bar');

    function currentDiscount(){
      const lvl = parseInt(levelEl.value || "1", 10);
      return (LEVELS[lvl] && LEVELS[lvl].discount_pct) ? LEVELS[lvl].discount_pct : 0;
    }
    function isWeapon(key){
      return CATALOG[key] && !!CATALOG[key].is_weapon;
    }

    function recompute(){
      let total = 0;
      const disc = currentDiscount();
      discountBadge.textContent = `–ó–Ω–∏–∂–∫–∞: ${disc}%`;

      document.querySelectorAll('input[name^="q_"]').forEach(inp => {
        const key = inp.getAttribute('data-key');
        const qty = Math.max(0, parseInt(inp.value || "0", 10));
        if(!key || !CATALOG[key] || qty <= 0) return;

        let unit = CATALOG[key].base_cost;
        if (isWeapon(key) && disc > 0){
          unit = Math.round(unit * (100 - disc) / 100);
        }
        total += unit * qty;
      });

      sumEl.textContent = total;

      const cap = parseInt(capEl.textContent, 10);
      // –ö–æ–ª—ñ—Ä –ø—ñ–¥—Å—É–º–∫—É
      sumEl.style.color = (total > cap) ? getComputedStyle(document.documentElement).getPropertyValue('--bad') : '#ffffff';

      // –ü—Ä–æ–≥—Ä–µ—Å
      const pct = Math.min(100, Math.round(100 * total / Math.max(1, cap)));
      pctEl.textContent = pct + '%';
      barEl.style.width = pct + '%';

      // –ö–æ–ª—ñ—Ä –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä–∞ –ø–æ –∑–æ–Ω—ñ
      let color = 'linear-gradient(90deg,#22c55e,#16a34a)'; // ok
      if (pct >= 85 && pct < 100) color = 'linear-gradient(90deg,#f59e0b,#eab308)';
      if (pct >= 100) color = 'linear-gradient(90deg,#ef4444,#f43f5e)';
      barEl.style.background = color;
    }

    document.querySelectorAll('input[name^="q_"]').forEach(inp => {
      inp.addEventListener('input', recompute);
    });
    levelEl.addEventListener('change', recompute);

    recompute();
  </script>
</body>
</html>
