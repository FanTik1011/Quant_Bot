<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ó–≤—ñ—Ç –∫—Ä–∞—Ñ—Ç—É | BCSD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{
      --glass: rgba(15, 18, 30, .78);
      --glass-strong: rgba(15, 18, 30, .88);
      --border: rgba(255,255,255,.14);
      --soft: rgba(255,255,255,.85);
      --accent:#14b8a6;
      --accent2:#0ea5e9;
      --focus: rgba(14,165,233,.25);
    }
    body{
      background:
        radial-gradient(1100px 520px at 110% -10%, rgba(88,101,242,.18), transparent 55%),
        radial-gradient(1000px 780px at -15% 120%, rgba(14,165,233,.16), transparent 60%),
        url("/static/bg.jpg") center/cover fixed no-repeat;
      min-height:100vh; color:#fff; font-family:'Segoe UI', system-ui, -apple-system, sans-serif;
      display:flex; align-items:center; justify-content:center; padding:26px;
    }
    .card-glass{
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:22px;
      padding:24px;
      width:100%; max-width:1000px;
      box-shadow:0 24px 64px rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      position:relative; overflow:hidden;
    }
    .card-glass:hover{ background:var(--glass-strong) }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .title{ margin:0; font-weight:900; letter-spacing:.2px; text-shadow:0 10px 26px rgba(0,0,0,.55); }
    .sub{ color:var(--soft); margin-top:-2px }
    .btn-logout{ background:#dc3545; border:none; color:#fff; font-weight:700; padding:.55rem .9rem; border-radius:.8rem; }
    .btn-logout:hover{ background:#b02a37 }
    label{ color:#f8fafc; font-weight:700; margin-bottom:.45rem }
    .form-text{ color:var(--soft) }
    .form-control, .form-select{
      background:#ffffff !important; color:#000 !important;
      border:1px solid #d0d7e2 !important; border-radius:.85rem !important;
      padding:.55rem .75rem !important; box-shadow:none !important;
    }
    .form-control:focus, .form-select:focus{
      border-color:#93c5fd !important;
      box-shadow:0 0 0 .25rem var(--focus) !important;
      outline:none;
    }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
    .items{ background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:18px; padding:16px; }
    .summary{ background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:18px; padding:16px; }
    .group-title{ font-weight:800; margin-bottom:10px }
    .row-item{ display:grid; grid-template-columns: 1fr 110px; gap:10px; align-items:center; margin-bottom:10px; }
    .muted{ color:var(--soft) }
    .cap{ font-weight:800; }
    .btn-send{
      background:linear-gradient(90deg, var(--accent), var(--accent2));
      border:none; color:#001018; font-weight:900;
      padding:.8rem 1.1rem; border-radius:1rem; width:100%;
      letter-spacing:.2px; transition:.2s;
    }
    .btn-send:hover{ transform:translateY(-1px); filter:brightness(1.05) }
    .badge-soft{ background: rgba(255,255,255,.14); color:#fff; border:1px solid var(--border) }
  </style>
</head>
<body>
  <div class="card-glass">
    <div class="header">
      <div>
        <h3 class="title">üß∞ –ó–≤—ñ—Ç –∫—Ä–∞—Ñ—Ç—É</h3>
        <div class="sub">BCSD Department ‚Äî –æ—Ñ—ñ—Ü—ñ–π–Ω–∞ —Ñ–æ—Ä–º–∞ –ø–æ–¥–∞—á—ñ</div>
      </div>
      {% if session.get('user') %}
        <a href="/logout" class="btn btn-logout">üö™ –í–∏–π—Ç–∏</a>
      {% endif %}
    </div>

    {% if request.args.get('ok') %}
      <div class="alert alert-success border-0 shadow-sm">‚úÖ –ó–≤—ñ—Ç —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ.</div>
    {% endif %}

    <form method="post" id="craftForm" class="mt-2">
      <div class="grid">
        <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="items">
          <div class="group-title">üì¶ –°–Ω–∞—Ä—è–¥–∂–µ–Ω–Ω—è</div>
          {% for key, item in catalog.items() %}
            <div class="row-item">
              <label class="form-label m-0">{{ item.label }}</label>
              <input type="number" min="0" step="1" value="0" class="form-control" name="q_{{ key }}" data-key="{{ key }}">
            </div>
          {% endfor %}
        </div>

        <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="summary">
          <div class="group-title">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>

          <div class="mb-3">
            <label class="form-label">–•—Ç–æ –∫—Ä–∞—Ñ—Ç–∏—Ç—å</label>
            <input class="form-control" value="{{ session['user']['username'] if session.get('user') else '' }}" disabled>
            <div class="form-text">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑ Discord</div>
          </div>

          <div class="mb-3">
            <label class="form-label">–†—ñ–≤–µ–Ω—å –∑–±—Ä–æ—è—Ä–∞</label>
            <select class="form-select" name="level" id="level">
              {% for lvl, info in levels.items() %}
                <option value="{{ lvl }}">–†—ñ–≤–µ–Ω—å {{ lvl }} (–∑–Ω–∏–∂–∫–∞: {{ info.discount_pct }}%)</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">–ú–µ—Ç–∞</label>
            <input class="form-control" name="purpose" placeholder="–¥–æ–±–æ–≤–∞ –Ω–æ—Ä–º–∞ –º–æ—è" required>
          </div>

          <hr class="border-secondary">

          <div class="d-flex justify-content-between">
            <div class="muted">–õ—ñ–º—ñ—Ç –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤</div>
            <div class="cap"><span id="cap">{{ role_cap }}</span> –º–∞—Ç.</div>
          </div>
          <div class="d-flex justify-content-between mt-1">
            <div class="muted">–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ —Å—É–º–∞</div>
            <div class="cap"><span id="sum">0</span> –º–∞—Ç.</div>
          </div>
          <div class="mt-2">
            <span class="badge badge-soft" id="discountBadge">–ó–Ω–∏–∂–∫–∞: 0%</span>
          </div>

          <button class="btn btn-send mt-3" type="submit">üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    const CATALOG = JSON.parse(`{{ catalog | tojson | safe }}`);
    const LEVELS  = JSON.parse(`{{ levels  | tojson | safe }}`);
    const capEl   = document.getElementById('cap');
    const sumEl   = document.getElementById('sum');
    const levelEl = document.getElementById('level');
    const discountBadge = document.getElementById('discountBadge');

    function currentDiscount(){
      const lvl = parseInt(levelEl.value || "1", 10);
      return (LEVELS[lvl] && LEVELS[lvl].discount_pct) ? LEVELS[lvl].discount_pct : 0;
    }

    function isWeapon(key){
      return CATALOG[key] && !!CATALOG[key].is_weapon;
    }

    function recompute(){
      let total = 0;
      const disc = currentDiscount();
      discountBadge.textContent = `–ó–Ω–∏–∂–∫–∞: ${disc}%`;

      document.querySelectorAll('input[name^="q_"]').forEach(inp => {
        const key = inp.getAttribute('data-key');
        const qty = Math.max(0, parseInt(inp.value || "0", 10));
        if(!key || !CATALOG[key] || qty <= 0) return;

        let unit = CATALOG[key].base_cost;
        if (isWeapon(key) && disc > 0){
          unit = Math.round(unit * (100 - disc) / 100);
        }
        total += unit * qty;
      });

      sumEl.textContent = total;
      const cap = parseInt(capEl.textContent, 10);
      sumEl.style.color = (total > cap) ? '#ff6b6b' : '#ffffff';
    }

    document.querySelectorAll('input[name^="q_"]').forEach(inp => {
      inp.addEventListener('input', recompute);
    });
    levelEl.addEventListener('change', recompute);

    recompute();
  </script>
</body>
</html>
